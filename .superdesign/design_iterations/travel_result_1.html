<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è¡Œè§„åˆ’ç»“æœ - æ™ºæ¸¸åŠ©æ‰‹v6.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#007AFF',
                        'brand-secondary': '#5856D6',
                        'surface': '#FFFFFF',
                        'surface-variant': '#F2F2F7',
                        'on-surface': '#1C1C1E',
                        'on-surface-variant': '#8E8E93',
                        'outline': '#C6C6C8',
                        'success': '#34C759',
                        'warning': '#FF9500',
                        'error': '#FF3B30'
                    },
                    spacing: {
                        '4': '16px',
                        '8': '32px',
                        '12': '48px',
                        '16': '64px',
                        '20': '80px',
                        '24': '96px'
                    },
                    borderRadius: {
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px'
                    },
                    fontSize: {
                        'display-large': ['36px', { lineHeight: '44px', fontWeight: '700' }],
                        'headline-large': ['28px', { lineHeight: '36px', fontWeight: '600' }],
                        'headline-medium': ['24px', { lineHeight: '32px', fontWeight: '600' }],
                        'title-large': ['20px', { lineHeight: '28px', fontWeight: '500' }],
                        'body-large': ['16px', { lineHeight: '24px', fontWeight: '400' }],
                        'body-medium': ['14px', { lineHeight: '20px', fontWeight: '400' }],
                        'label-large': ['14px', { lineHeight: '20px', fontWeight: '500' }]
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-surface-variant min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="bg-surface border-b border-outline sticky top-0 z-50 backdrop-blur-md bg-opacity-95">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="goBack()" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-outline text-on-surface hover:bg-surface-variant transition-colors">
                        <i class="fas fa-arrow-left"></i>
                        <span>è¿”å›</span>
                    </button>
                    <div>
                        <h1 id="planTitle" class="text-headline-medium text-on-surface">åŠ è½½ä¸­...</h1>
                        <p id="planSubtitle" class="text-body-medium text-on-surface-variant">æ­£åœ¨è·å–è¡Œç¨‹ä¿¡æ¯</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button class="p-2 rounded-lg hover:bg-surface-variant transition-colors" title="åˆ†äº«è¡Œç¨‹">
                        <i class="fas fa-share-alt text-on-surface-variant"></i>
                    </button>
                    <button class="p-2 rounded-lg hover:bg-surface-variant transition-colors" title="æ”¶è—è¡Œç¨‹">
                        <i class="fas fa-heart text-on-surface-variant"></i>
                    </button>
                    <button class="flex items-center gap-2 px-4 py-2 bg-brand-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        <i class="fas fa-download"></i>
                        <span>å¯¼å‡ºè¡Œç¨‹</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" class="flex items-center justify-center py-20">
            <div class="bg-surface rounded-2xl p-8 shadow-lg text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-primary mx-auto mb-4"></div>
                <h3 class="text-headline-medium text-on-surface mb-2">æ­£åœ¨åŠ è½½è¡Œç¨‹</h3>
                <p class="text-body-medium text-on-surface-variant">è¯·ç¨å€™...</p>
            </div>
        </div>

        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="errorState" class="hidden flex items-center justify-center py-20">
            <div class="bg-surface rounded-2xl p-8 shadow-lg text-center max-w-md">
                <div class="text-error mb-4">
                    <i class="fas fa-exclamation-triangle text-4xl"></i>
                </div>
                <h3 class="text-headline-medium text-on-surface mb-2">åŠ è½½å¤±è´¥</h3>
                <p id="errorMessage" class="text-body-medium text-on-surface-variant mb-4">æ— æ³•åŠ è½½è¡Œç¨‹æ•°æ®</p>
                <button onclick="retryLoad()" class="px-4 py-2 bg-brand-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                    é‡è¯•
                </button>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div id="mainContent" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- å·¦ä¾§è¡Œç¨‹åˆ—è¡¨ -->
                <div class="lg:col-span-9">
                    <div id="itineraryList" class="space-y-6">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„è¡Œç¨‹å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>

                <!-- å³ä¾§è¾¹æ  -->
                <div class="lg:col-span-3">
                    <div class="bg-surface rounded-2xl p-6 shadow-lg">
                        <h3 class="text-headline-medium text-on-surface mb-4">æ—…è¡Œè´´å£«</h3>
                        <div class="space-y-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-lightbulb text-warning mt-1"></i>
                                <div>
                                    <p class="text-label-large text-on-surface">æœ€ä½³å‡ºè¡Œæ—¶é—´</p>
                                    <p class="text-body-medium text-on-surface-variant">å»ºè®®æå‰1-2å‘¨é¢„è®¢æœºç¥¨å’Œé…’åº—</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <i class="fas fa-umbrella text-brand-primary mt-1"></i>
                                <div>
                                    <p class="text-label-large text-on-surface">å¤©æ°”å‡†å¤‡</p>
                                    <p class="text-body-medium text-on-surface-variant">å…³æ³¨å¤©æ°”é¢„æŠ¥ï¼Œå‡†å¤‡åˆé€‚çš„è¡£ç‰©</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <i class="fas fa-credit-card text-success mt-1"></i>
                                <div>
                                    <p class="text-label-large text-on-surface">æ”¯ä»˜æ–¹å¼</p>
                                    <p class="text-body-medium text-on-surface-variant">å»ºè®®æºå¸¦ç°é‡‘å’Œé“¶è¡Œå¡</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let sessionId = null;
        let planData = null;
        let demoMode = false;

        // æ¼”ç¤ºæ•°æ®
        const demoData = {
            id: 'demo_session_001',
            title: 'å—äº¬3æ—¥æ–‡åŒ–æ·±åº¦æ¸¸',
            destination: 'å—äº¬',
            totalDays: 3,
            startDate: '2025-08-15',
            endDate: '2025-08-17',
            totalCost: 1580,
            groupSize: 2,
            itinerary: [
                {
                    day: 1,
                    date: '8æœˆ15æ—¥ å‘¨å››',
                    location: 'å—äº¬å¸‚ä¸­å¿ƒ',
                    weather: 'æ™´æœ—',
                    temperature: '28Â°C',
                    activities: [
                        {
                            time: '09:00-12:00',
                            title: 'ä¸­å±±é™µæ™¯åŒºæ¸¸è§ˆ',
                            description: 'å‚è§‚ä¸­å±±é™µï¼Œæ„Ÿå—æ°‘å›½å†å²æ–‡åŒ–ã€‚ç™»ä¸Š392çº§å°é˜¶ï¼Œä¿¯ç°å—äº¬åŸæ™¯ã€‚å»ºè®®ç©¿èˆ’é€‚çš„è¿åŠ¨é‹ï¼Œå¸¦å¥½é˜²æ™’ç”¨å“ã€‚',
                            icon: 'ğŸ›ï¸',
                            cost: 0,
                            duration: 'çº¦3å°æ—¶',
                            period: 'ä¸Šåˆ'
                        },
                        {
                            time: '14:00-17:00',
                            title: 'æ˜å­é™µæ¢ç§˜',
                            description: 'æ¢è®¿æ˜æœå¼€å›½çš‡å¸æœ±å…ƒç’‹çš„é™µå¢“ï¼Œæ¼«æ­¥ç¥é“ï¼Œæ¬£èµå¤ä»£å»ºç­‘è‰ºæœ¯ã€‚ä¸–ç•Œæ–‡åŒ–é—äº§ï¼Œå†å²ä»·å€¼æé«˜ã€‚',
                            icon: 'ğŸ‘‘',
                            cost: 70,
                            duration: 'çº¦3å°æ—¶',
                            period: 'ä¸‹åˆ'
                        },
                        {
                            time: '18:00-20:00',
                            title: 'å¤«å­åº™ç¾é£Ÿè¡—',
                            description: 'å“å°å—äº¬ç‰¹è‰²å°åƒï¼šé¸­è¡€ç²‰ä¸æ±¤ã€å°ç¬¼åŒ…ã€æ¡‚èŠ±ç³–èŠ‹è‹—ã€‚æ„Ÿå—ç§¦æ·®æ²³ç•”çš„å¤œæ™¯å’Œå†å²æ–‡åŒ–æ°›å›´ã€‚',
                            icon: 'ğŸœ',
                            cost: 120,
                            duration: 'çº¦2å°æ—¶',
                            period: 'æ™šä¸Š'
                        }
                    ]
                },
                {
                    day: 2,
                    date: '8æœˆ16æ—¥ å‘¨äº”',
                    location: 'å—äº¬è€åŸåŒº',
                    weather: 'å¤šäº‘',
                    temperature: '26Â°C',
                    activities: [
                        {
                            time: '09:00-12:00',
                            title: 'å—äº¬åšç‰©é™¢',
                            description: 'ä¸­å›½ä¸‰å¤§åšç‰©é¦†ä¹‹ä¸€ï¼Œé¦†è—ä¸°å¯Œã€‚é‡ç‚¹å‚è§‚å†å²é¦†å’Œè‰ºæœ¯é¦†ï¼Œäº†è§£æ±Ÿè‹åœ°åŒºçš„å†å²æ–‡åŒ–å‘å±•è„‰ç»œã€‚',
                            icon: 'ğŸ›ï¸',
                            cost: 0,
                            duration: 'çº¦3å°æ—¶',
                            period: 'ä¸Šåˆ'
                        },
                        {
                            time: '14:00-16:30',
                            title: 'æ€»ç»Ÿåºœå†å²å»ºç­‘ç¾¤',
                            description: 'å‚è§‚ä¸­å›½è¿‘ä»£å²é—å€åšç‰©é¦†ï¼Œäº†è§£å¤ªå¹³å¤©å›½å’Œä¸­åæ°‘å›½çš„å†å²ã€‚å»ºç­‘é£æ ¼ç‹¬ç‰¹ï¼Œå†å²ä»·å€¼é‡å¤§ã€‚',
                            icon: 'ğŸ¢',
                            cost: 40,
                            duration: 'çº¦2.5å°æ—¶',
                            period: 'ä¸‹åˆ'
                        },
                        {
                            time: '17:00-19:00',
                            title: 'ç„æ­¦æ¹–å…¬å›­',
                            description: 'å—äº¬æœ€å¤§çš„åŸå†…å…¬å›­ï¼Œæ¹–å…‰å±±è‰²ç¾ä¸èƒœæ”¶ã€‚å¯ä»¥ç§Ÿèˆ¹æ¸¸æ¹–ï¼Œæˆ–åœ¨æ¹–è¾¹æ¼«æ­¥ï¼Œäº«å—å®é™çš„é»„æ˜æ—¶å…‰ã€‚',
                            icon: 'ğŸŒŠ',
                            cost: 0,
                            duration: 'çº¦2å°æ—¶',
                            period: 'å‚æ™š'
                        }
                    ]
                },
                {
                    day: 3,
                    date: '8æœˆ17æ—¥ å‘¨å…­',
                    location: 'å—äº¬æ–°è¡—å£',
                    weather: 'æ™´æœ—',
                    temperature: '30Â°C',
                    activities: [
                        {
                            time: '09:00-11:30',
                            title: 'é›¨èŠ±å°çƒˆå£«é™µå›­',
                            description: 'ç¼…æ€€é©å‘½å…ˆçƒˆï¼Œäº†è§£ä¸­å›½è¿‘ç°ä»£é©å‘½å†å²ã€‚å›­å†…ç»¿æ ‘æˆè«ï¼Œç¯å¢ƒåº„ä¸¥è‚ƒç©†ï¼Œæ˜¯è¿›è¡Œçˆ±å›½ä¸»ä¹‰æ•™è‚²çš„é‡è¦åœºæ‰€ã€‚',
                            icon: 'ğŸŒ¹',
                            cost: 0,
                            duration: 'çº¦2.5å°æ—¶',
                            period: 'ä¸Šåˆ'
                        },
                        {
                            time: '14:00-17:00',
                            title: 'æ–°è¡—å£å•†åœˆè´­ç‰©',
                            description: 'å—äº¬æœ€ç¹åçš„å•†ä¸šä¸­å¿ƒï¼Œè´­ä¹°ç‰¹äº§å’Œçºªå¿µå“ã€‚æ¨èè´­ä¹°ï¼šå—äº¬äº‘é”¦ã€é›¨èŠ±èŒ¶ã€ç›æ°´é¸­ç­‰ç‰¹è‰²äº§å“ã€‚',
                            icon: 'ğŸ›ï¸',
                            cost: 350,
                            duration: 'çº¦3å°æ—¶',
                            period: 'ä¸‹åˆ'
                        }
                    ]
                }
            ],
            createdAt: new Date().toISOString()
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»URLè·å–sessionId
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('sessionId');

            if (!sessionId) {
                // æ²¡æœ‰sessionIdï¼Œè¿›å…¥æ¼”ç¤ºæ¨¡å¼
                console.log('ğŸ­ è¿›å…¥æ¼”ç¤ºæ¨¡å¼');
                demoMode = true;
                loadDemoData();
            } else {
                // æœ‰sessionIdï¼Œå°è¯•åŠ è½½çœŸå®æ•°æ®
                loadTravelPlan();
            }
        });

        // åŠ è½½æ¼”ç¤ºæ•°æ®
        function loadDemoData() {
            console.log('ğŸ­ åŠ è½½æ¼”ç¤ºæ•°æ®');
            planData = demoData;

            // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿï¼Œå±•ç¤ºåŠ è½½åŠ¨ç”»
            setTimeout(() => {
                renderTravelPlan();
            }, 1500);
        }

        // åŠ è½½æ—…è¡Œè®¡åˆ’æ•°æ®
        async function loadTravelPlan() {
            try {
                console.log('ğŸ“‹ è·å–æ—…è¡Œè®¡åˆ’ç»“æœ:', sessionId);

                const response = await fetch(`/api/v1/planning/sessions/${sessionId}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'è·å–æ•°æ®å¤±è´¥');
                }

                if (result.success && result.data) {
                    planData = {
                        id: sessionId,
                        title: `${result.data.destination}æ·±åº¦æ¸¸`,
                        destination: result.data.destination,
                        totalDays: result.data.totalDays || 0,
                        startDate: result.data.startDate || '',
                        endDate: result.data.endDate || '',
                        totalCost: calculateTotalCost(result.data.result?.itinerary || []),
                        groupSize: result.data.userPreferences?.groupSize || 2,
                        itinerary: result.data.result?.itinerary || [],
                        createdAt: new Date().toISOString()
                    };

                    renderTravelPlan();
                } else {
                    throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½æ—…è¡Œè®¡åˆ’å¤±è´¥:', error);
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œfallbackåˆ°æ¼”ç¤ºæ¨¡å¼
                console.log('ğŸ­ APIè°ƒç”¨å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼');
                demoMode = true;
                loadDemoData();
            }
        }

        // è®¡ç®—æ€»è´¹ç”¨
        function calculateTotalCost(itinerary) {
            let total = 0;
            itinerary.forEach(day => {
                if (day.activities) {
                    day.activities.forEach(activity => {
                        total += activity.cost || 0;
                    });
                }
            });
            return total;
        }

        // æ¸²æŸ“æ—…è¡Œè®¡åˆ’
        function renderTravelPlan() {
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('planTitle').textContent = planData.title;
            document.getElementById('planSubtitle').textContent =
                `${planData.destination} Â· ${planData.totalDays}å¤© Â· é¢„ç®— Â¥${planData.totalCost}${demoMode ? ' (æ¼”ç¤ºæ¨¡å¼)' : ''}`;

            // æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨
            const itineraryList = document.getElementById('itineraryList');
            itineraryList.innerHTML = '';

            if (planData.itinerary && planData.itinerary.length > 0) {
                planData.itinerary.forEach((day, index) => {
                    const dayCard = createDayCard(day, index + 1);
                    itineraryList.appendChild(dayCard);
                });
            } else {
                itineraryList.innerHTML = `
                    <div class="bg-surface rounded-2xl p-8 shadow-lg text-center">
                        <div class="text-on-surface-variant mb-4">
                            <i class="fas fa-calendar-day text-4xl"></i>
                        </div>
                        <h3 class="text-headline-medium text-on-surface mb-2">è¡Œç¨‹è¯¦æƒ…ç”Ÿæˆä¸­</h3>
                        <p class="text-body-medium text-on-surface-variant">æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†çš„æ¯æ—¥è¡Œç¨‹å®‰æ’...</p>
                    </div>
                `;
            }

            // æ˜¾ç¤ºæ¼”ç¤ºæ¨¡å¼æç¤º
            if (demoMode) {
                const demoNotice = document.createElement('div');
                demoNotice.className = 'bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-6 text-center';
                demoNotice.innerHTML = `
                    <div class="flex items-center justify-center gap-2 text-blue-600">
                        <i class="fas fa-info-circle"></i>
                        <span class="font-medium">æ¼”ç¤ºæ¨¡å¼</span>
                    </div>
                    <p class="text-sm text-blue-600 mt-1">è¿™æ˜¯è®¾è®¡æ¼”ç¤ºæ•°æ®ï¼Œå±•ç¤ºé¡µé¢å¸ƒå±€å’Œäº¤äº’æ•ˆæœ</p>
                `;
                itineraryList.insertBefore(demoNotice, itineraryList.firstChild);
            }

            // æ˜¾ç¤ºä¸»è¦å†…å®¹
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // åˆ›å»ºæ—¥ç¨‹å¡ç‰‡
        function createDayCard(dayData, dayNumber) {
            const card = document.createElement('div');
            card.className = 'bg-surface rounded-2xl shadow-lg overflow-hidden';
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-brand-primary text-white rounded-full flex items-center justify-center text-label-large">
                                ${dayNumber}
                            </div>
                            <div>
                                <h3 class="text-title-large text-on-surface">Day ${dayNumber}</h3>
                                <p class="text-body-medium text-on-surface-variant">${dayData.date || formatDate(dayNumber)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-body-medium text-on-surface-variant">
                                <i class="fas fa-map-marker-alt mr-1"></i>${dayData.location || planData.destination}
                            </p>
                            <p class="text-body-medium text-on-surface-variant">
                                <i class="fas fa-thermometer-half mr-1"></i>${dayData.weather || 'æ™´æœ—'} ${dayData.temperature || '25Â°C'}
                            </p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${(dayData.activities || []).map(activity => `
                            <div class="border-l-4 border-brand-primary pl-4">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-body-medium text-on-surface-variant">${activity.time || 'å…¨å¤©'}</span>
                                            <span class="text-body-medium text-brand-primary">${activity.period || ''}</span>
                                        </div>
                                        <h4 class="text-title-large text-on-surface mb-2">${activity.title}</h4>
                                        <p class="text-body-medium text-on-surface-variant mb-2">${activity.description}</p>
                                        <div class="flex items-center gap-4 text-body-medium text-on-surface-variant">
                                            <span><i class="fas fa-clock mr-1"></i>${activity.duration || 'çº¦2å°æ—¶'}</span>
                                            ${activity.cost ? `<span><i class="fas fa-yen-sign mr-1"></i>Â¥${activity.cost}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-2xl ml-4">${activity.icon || 'ğŸ“'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            return card;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dayNumber) {
            if (!planData.startDate) return `ç¬¬${dayNumber}å¤©`;
            
            const startDate = new Date(planData.startDate);
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + dayNumber - 1);
            
            return currentDate.toLocaleDateString('zh-CN', { 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        // é‡è¯•åŠ è½½
        function retryLoad() {
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            loadTravelPlan();
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/planning';
            }
        }
    </script>
</body>
</html>
