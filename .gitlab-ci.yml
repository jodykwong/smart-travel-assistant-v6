# æ™ºæ¸¸åŠ©æ‰‹v6.2 GitLab CI/CD Pipeline
# Week 3-4: å®Œæ•´CI Pipelineæ„å»º
# åŸºäºé˜¶æ®µä¸€åŸºç¡€è®¾æ–½ï¼šGitLab CE + Harbor + K3s + ç›‘æ§ç³»ç»Ÿ

variables:
  # Dockeré•œåƒé…ç½®
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

  # Harboré•œåƒä»“åº“é…ç½®
  HARBOR_REGISTRY: "harbor.smarttravel.local"
  HARBOR_PROJECT: "smart-travel"
  IMAGE_NAME: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/smart-travel-assistant"

  # åº”ç”¨é…ç½®
  APP_NAME: "smart-travel-assistant"
  APP_VERSION: "6.2.0"
  NODE_VERSION: "18"
  PNPM_VERSION: "8.10.0"

  # æµ‹è¯•é…ç½®
  COVERAGE_THRESHOLD: "80"

  # å®‰å…¨æ‰«æé…ç½®
  TRIVY_VERSION: "0.47.0"

  # K8sé…ç½®
  KUBECONFIG: "/tmp/kubeconfig"
  KUBE_NAMESPACE_DEV: "smart-travel-dev"
  KUBE_NAMESPACE_STAGING: "smart-travel-staging"
  KUBE_NAMESPACE_PROD: "smart-travel-production"

stages:
  - validate      # ä»£ç éªŒè¯å’Œä¾èµ–æ£€æŸ¥
  - test         # è‡ªåŠ¨åŒ–æµ‹è¯•
  - security     # å®‰å…¨æ‰«æ
  - build        # æ„å»ºå’Œæ‰“åŒ…
  - deploy       # éƒ¨ç½²åˆ°å„ç¯å¢ƒ

# ç¼“å­˜é…ç½®
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - node_modules/
    - .pnpm-store/
    - .next/cache/

# é€šç”¨è„šæœ¬
.common_scripts: &common_scripts
  - echo "ğŸš€ æ™ºæ¸¸åŠ©æ‰‹v6.2 CI/CD Pipeline - Stage:$CI_JOB_STAGE Job:$CI_JOB_NAME"
  - echo "ğŸ“Š é›†æˆç°æœ‰ç›‘æ§ç³»ç»Ÿ - MetricsRegistry + MetricsCollector + ErrorHandler"
  - export CI_PIPELINE_START_TIME=$(date +%s)

# Node.jsç¯å¢ƒå‡†å¤‡
.node_setup: &node_setup
  image: node:${NODE_VERSION}-alpine
  before_script:
    - *common_scripts
    - apk add --no-cache git curl jq
    - npm install -g pnpm@${PNPM_VERSION}
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile

# Dockerç¯å¢ƒå‡†å¤‡
.docker_setup: &docker_setup
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - *common_scripts
    - docker info
    - echo $HARBOR_PASSWORD | docker login $HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin

# ==================== VALIDATEé˜¶æ®µ ====================

# ä¾èµ–å®‰å…¨æ£€æŸ¥
dependency_check:
  stage: validate
  <<: *node_setup
  script:
    - echo "ğŸ” æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§..."
    - pnpm audit --audit-level moderate
    - echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ä»£ç æ ¼å¼æ£€æŸ¥
lint_check:
  stage: validate
  <<: *node_setup
  script:
    - echo "ğŸ” ä»£ç æ ¼å¼å’Œè´¨é‡æ£€æŸ¥..."
    - pnpm run lint
    - pnpm run type-check
    - echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
  artifacts:
    reports:
      junit: reports/lint-results.xml
    paths:
      - reports/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# æ¶æ„è´¨é‡æ£€æŸ¥
architecture_check:
  stage: validate
  <<: *node_setup
  script:
    - echo "ğŸ—ï¸ æ¶æ„è´¨é‡æ£€æŸ¥..."
    - echo "æ£€æŸ¥æ¨¡å—ä¾èµ–å…³ç³»..."
    - npx madge --circular --extensions ts,tsx src/
    - echo "æ£€æŸ¥ä»£ç å¤æ‚åº¦..."
    - npx complexity-report --format json --output reports/complexity.json src/
    - echo "æ£€æŸ¥æŠ€æœ¯å€ºåŠ¡..."
    - npx ts-prune --error
    - echo "âœ… æ¶æ„è´¨é‡æ£€æŸ¥é€šè¿‡"
  artifacts:
    paths:
      - reports/complexity.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ==================== TESTé˜¶æ®µ ====================

# å•å…ƒæµ‹è¯•
unit_tests:
  stage: test
  <<: *node_setup
  script:
    - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    - pnpm run test:unit --coverage --reporter=junit --outputFile=reports/unit-tests.xml
    - echo "ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥..."
    - npx nyc check-coverage --lines $COVERAGE_THRESHOLD --functions $COVERAGE_THRESHOLD --branches $COVERAGE_THRESHOLD
    - echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡ï¼Œè¦†ç›–ç‡è¾¾æ ‡"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      junit: reports/unit-tests.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
      - reports/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# é›†æˆæµ‹è¯•
integration_tests:
  stage: test
  <<: *node_setup
  services:
    - postgres:15-alpine
    - redis:7-alpine
  variables:
    POSTGRES_DB: smart_travel_test
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    REDIS_URL: redis://redis:6379
  script:
    - echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
    - echo "å¯åŠ¨æµ‹è¯•æ•°æ®åº“å’Œç¼“å­˜..."
    - pnpm run test:integration --reporter=junit --outputFile=reports/integration-tests.xml
    - echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
  artifacts:
    reports:
      junit: reports/integration-tests.xml
    paths:
      - reports/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# E2Eæµ‹è¯•
e2e_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  variables:
    NODE_ENV: test
  before_script:
    - *common_scripts
    - npm install -g pnpm@${PNPM_VERSION}
    - pnpm install --frozen-lockfile
    - pnpm exec playwright install
  script:
    - echo "ğŸ­ è¿è¡ŒE2Eæµ‹è¯•..."
    - pnpm run build:test
    - pnpm run start:test &
    - sleep 30
    - pnpm run test:e2e --reporter=junit --outputFile=reports/e2e-tests.xml
    - echo "âœ… E2Eæµ‹è¯•é€šè¿‡"
  artifacts:
    reports:
      junit: reports/e2e-tests.xml
    paths:
      - test-results/
      - reports/
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

# ç›‘æ§ç³»ç»Ÿæµ‹è¯•
monitoring_tests:
  stage: test
  <<: *node_setup
  script:
    - echo "ğŸ“Š æµ‹è¯•ç›‘æ§ç³»ç»Ÿé›†æˆ..."
    - echo "æµ‹è¯•MetricsRegistry..."
    - pnpm run test src/lib/monitoring/MetricsRegistry.ts
    - echo "æµ‹è¯•MetricsCollector..."
    - pnpm run test src/lib/monitoring/MetricsCollector.ts
    - echo "æµ‹è¯•ErrorHandler..."
    - pnpm run test src/lib/monitoring/ErrorHandler.ts
    - echo "æµ‹è¯•ç›‘æ§ç«¯ç‚¹..."
    - pnpm run test:monitoring
    - echo "âœ… ç›‘æ§ç³»ç»Ÿæµ‹è¯•é€šè¿‡"
  artifacts:
    paths:
      - reports/monitoring-tests.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ==================== SECURITYé˜¶æ®µ ====================

# ä¾èµ–æ¼æ´æ‰«æ
dependency_security_scan:
  stage: security
  <<: *node_setup
  script:
    - echo "ğŸ”’ ä¾èµ–æ¼æ´æ‰«æ..."
    - pnpm audit --audit-level high --json > reports/npm-audit.json || true
    - echo "æ£€æŸ¥é«˜å±æ¼æ´..."
    - if [ $(jq '.metadata.vulnerabilities.high // 0' reports/npm-audit.json) -gt 0 ]; then
        echo "âŒ å‘ç°é«˜å±æ¼æ´ï¼Œé˜»æ­¢éƒ¨ç½²";
        exit 1;
      fi
    - echo "âœ… ä¾èµ–å®‰å…¨æ‰«æé€šè¿‡"
  artifacts:
    paths:
      - reports/npm-audit.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ä»£ç å®‰å…¨æ‰«æ
code_security_scan:
  stage: security
  <<: *node_setup
  script:
    - echo "ğŸ” ä»£ç å®‰å…¨æ‰«æ..."
    - npm install -g @eslint/eslintrc eslint-plugin-security
    - npx eslint --ext .ts,.tsx --config .eslintrc.security.js src/ --format json --output-file reports/security-scan.json || true
    - echo "æ£€æŸ¥å®‰å…¨é—®é¢˜..."
    - if [ $(jq 'length' reports/security-scan.json) -gt 0 ]; then
        echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥æŠ¥å‘Š";
      fi
    - echo "âœ… ä»£ç å®‰å…¨æ‰«æå®Œæˆ"
  artifacts:
    paths:
      - reports/security-scan.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# é•œåƒå®‰å…¨æ‰«æ
image_security_scan:
  stage: security
  image: aquasec/trivy:${TRIVY_VERSION}
  before_script:
    - *common_scripts
  script:
    - echo "ğŸ³ Dockeré•œåƒå®‰å…¨æ‰«æ..."
    - trivy image --format json --output reports/trivy-image.json ${IMAGE_NAME}:${CI_COMMIT_SHA} || true
    - trivy image --format table ${IMAGE_NAME}:${CI_COMMIT_SHA}
    - echo "æ£€æŸ¥ä¸¥é‡æ¼æ´..."
    - CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' reports/trivy-image.json)
    - if [ "$CRITICAL_COUNT" -gt 0 ]; then
        echo "âŒ å‘ç° $CRITICAL_COUNT ä¸ªä¸¥é‡æ¼æ´ï¼Œé˜»æ­¢éƒ¨ç½²";
        exit 1;
      fi
    - echo "âœ… é•œåƒå®‰å…¨æ‰«æé€šè¿‡"
  artifacts:
    paths:
      - reports/trivy-image.json
    expire_in: 1 week
  dependencies:
    - build_image
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ==================== BUILDé˜¶æ®µ ====================

# æ„å»ºåº”ç”¨
build_app:
  stage: build
  <<: *node_setup
  script:
    - echo "ğŸ—ï¸ æ„å»ºåº”ç”¨..."
    - echo "é›†æˆç›‘æ§ç³»ç»Ÿç»„ä»¶..."
    - pnpm run build
    - echo "ç”Ÿæˆæ„å»ºæŠ¥å‘Š..."
    - ls -la .next/
    - echo "âœ… åº”ç”¨æ„å»ºå®Œæˆ"
  artifacts:
    paths:
      - .next/
      - public/
      - package.json
      - package-lock.json
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# æ„å»ºDockeré•œåƒ
build_image:
  stage: build
  <<: *docker_setup
  script:
    - echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
    - echo "FROM node:${NODE_VERSION}-alpine" > Dockerfile.ci
    - echo "WORKDIR /app" >> Dockerfile.ci
    - echo "COPY package*.json ./" >> Dockerfile.ci
    - echo "RUN npm ci --only=production" >> Dockerfile.ci
    - echo "COPY .next ./.next" >> Dockerfile.ci
    - echo "COPY public ./public" >> Dockerfile.ci
    - echo "EXPOSE 3000" >> Dockerfile.ci
    - echo "CMD [\"npm\", \"start\"]" >> Dockerfile.ci
    - docker build -f Dockerfile.ci -t ${IMAGE_NAME}:${CI_COMMIT_SHA} .
    - docker tag ${IMAGE_NAME}:${CI_COMMIT_SHA} ${IMAGE_NAME}:latest
    - echo "æ¨é€é•œåƒåˆ°Harbor..."
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHA}
    - docker push ${IMAGE_NAME}:latest
    - echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"
  dependencies:
    - build_app
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ==================== DEPLOYé˜¶æ®µ ====================

# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
deploy_dev:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - *common_scripts
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - kubectl version --client
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
    - kubectl config set-context --current --namespace=$KUBE_NAMESPACE_DEV
    - envsubst < ci/k8s-deployment-template.yml > deployment.yml
    - kubectl apply -f deployment.yml
    - kubectl rollout status deployment/${APP_NAME} -n $KUBE_NAMESPACE_DEV
    - echo "éªŒè¯éƒ¨ç½²..."
    - kubectl get pods -n $KUBE_NAMESPACE_DEV
    - echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: development
    url: https://dev.smarttravel.local
  dependencies:
    - build_image
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
deploy_staging:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - *common_scripts
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - kubectl version --client
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
    - kubectl config set-context --current --namespace=$KUBE_NAMESPACE_STAGING
    - envsubst < ci/k8s-deployment-template.yml > deployment.yml
    - kubectl apply -f deployment.yml
    - kubectl rollout status deployment/${APP_NAME} -n $KUBE_NAMESPACE_STAGING
    - echo "è¿è¡Œéƒ¨ç½²åæµ‹è¯•..."
    - ./ci/post-deployment-tests.sh staging
    - echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: staging
    url: https://staging.smarttravel.local
  dependencies:
    - build_image
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆæ”¯ä»˜ç³»ç»Ÿç‰¹æ®Šä¿æŠ¤ï¼‰
deploy_production:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - *common_scripts
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - kubectl version --client
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆè“ç»¿éƒ¨ç½²ï¼‰..."
    - echo "æ‰§è¡Œæ”¯ä»˜ç³»ç»Ÿç‰¹æ®Šä¿æŠ¤ç­–ç•¥..."
    - ./ci/payment-system-protection.sh pre-deploy
    - kubectl config set-context --current --namespace=$KUBE_NAMESPACE_PROD
    - echo "å¼€å§‹è“ç»¿éƒ¨ç½²..."
    - ./ci/blue-green-deployment.sh ${IMAGE_NAME}:${CI_COMMIT_SHA}
    - echo "éªŒè¯éƒ¨ç½²å’Œç›‘æ§..."
    - ./ci/post-deployment-tests.sh production
    - ./ci/payment-system-protection.sh post-deploy
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: production
    url: https://api.smarttravel.com
  dependencies:
    - build_image
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  timeout: 30m

# ==================== CD PIPELINEæ‰©å±• (Week 5-6) ====================

# Helm ChartéªŒè¯
helm_lint:
  stage: validate
  image: alpine/helm:latest
  before_script:
    - *common_scripts
    - helm version
  script:
    - echo "ğŸ” Helm Chartè¯­æ³•æ£€æŸ¥..."
    - helm lint helm/smart-travel/
    - echo "ğŸ” Helmæ¨¡æ¿æ¸²æŸ“æµ‹è¯•..."
    - helm template smart-travel helm/smart-travel/ --values helm/smart-travel/values-development.yaml > /dev/null
    - helm template smart-travel helm/smart-travel/ --values helm/smart-travel/values-production.yaml > /dev/null
    - echo "âœ… Helm ChartéªŒè¯é€šè¿‡"
  artifacts:
    paths:
      - reports/helm-lint.txt
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Kubernetesé…ç½®éªŒè¯
k8s_config_validation:
  stage: validate
  image: bitnami/kubectl:latest
  before_script:
    - *common_scripts
  script:
    - echo "ğŸ” Kubernetesé…ç½®éªŒè¯..."
    - helm template smart-travel helm/smart-travel/ --values helm/smart-travel/values-production.yaml > k8s-manifests.yaml
    - kubectl --dry-run=client apply -f k8s-manifests.yaml
    - echo "âœ… Kubernetesé…ç½®éªŒè¯é€šè¿‡"
  artifacts:
    paths:
      - k8s-manifests.yaml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Helm Chartæ‰“åŒ…
helm_package:
  stage: build
  image: alpine/helm:latest
  before_script:
    - *common_scripts
    - helm version
  script:
    - echo "ğŸ“¦ æ‰“åŒ…Helm Chart..."
    - helm package helm/smart-travel/ --version ${APP_VERSION} --app-version ${APP_VERSION}
    - echo "æ¨é€Helm Chartåˆ°Harbor..."
    - helm registry login $HARBOR_REGISTRY -u $HARBOR_USERNAME -p $HARBOR_PASSWORD
    - helm push smart-travel-assistant-${APP_VERSION}.tgz oci://$HARBOR_REGISTRY/$HARBOR_PROJECT
    - echo "âœ… Helm Chartæ‰“åŒ…å®Œæˆ"
  artifacts:
    paths:
      - smart-travel-assistant-*.tgz
    expire_in: 1 week
  dependencies:
    - build_image
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ä½¿ç”¨Helméƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
helm_deploy_dev:
  stage: deploy
  image: alpine/helm:latest
  before_script:
    - *common_scripts
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - helm version
    - kubectl version --client
  script:
    - echo "ğŸš€ ä½¿ç”¨Helméƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
    - kubectl config set-context --current --namespace=$KUBE_NAMESPACE_DEV
    - helm registry login $HARBOR_REGISTRY -u $HARBOR_USERNAME -p $HARBOR_PASSWORD
    - |
      helm upgrade --install smart-travel-dev oci://$HARBOR_REGISTRY/$HARBOR_PROJECT/smart-travel-assistant \
        --version ${APP_VERSION} \
        --namespace $KUBE_NAMESPACE_DEV \
        --create-namespace \
        --values helm/smart-travel/values-development.yaml \
        --set app.image.tag=${CI_COMMIT_SHA} \
        --set global.imageRegistry=$HARBOR_REGISTRY \
        --set global.imageProject=$HARBOR_PROJECT \
        --wait --timeout=600s
    - echo "éªŒè¯éƒ¨ç½²..."
    - kubectl get pods -n $KUBE_NAMESPACE_DEV
    - kubectl rollout status deployment/smart-travel-dev -n $KUBE_NAMESPACE_DEV
    - echo "âœ… å¼€å‘ç¯å¢ƒHelméƒ¨ç½²å®Œæˆ"
  environment:
    name: development
    url: https://dev.smarttravel.local
  dependencies:
    - helm_package
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

# ä½¿ç”¨Helméƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
helm_deploy_staging:
  stage: deploy
  image: alpine/helm:latest
  before_script:
    - *common_scripts
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - helm version
    - kubectl version --client
  script:
    - echo "ğŸš€ ä½¿ç”¨Helméƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
    - kubectl config set-context --current --namespace=$KUBE_NAMESPACE_STAGING
    - helm registry login $HARBOR_REGISTRY -u $HARBOR_USERNAME -p $HARBOR_PASSWORD
    - |
      helm upgrade --install smart-travel-staging oci://$HARBOR_REGISTRY/$HARBOR_PROJECT/smart-travel-assistant \
        --version ${APP_VERSION} \
        --namespace $KUBE_NAMESPACE_STAGING \
        --create-namespace \
        --values helm/smart-travel/values.yaml \
        --set app.image.tag=${CI_COMMIT_SHA} \
        --set global.imageRegistry=$HARBOR_REGISTRY \
        --set global.imageProject=$HARBOR_PROJECT \
        --set app.env.NODE_ENV=staging \
        --set configMap.data.NODE_ENV=staging \
        --wait --timeout=600s
    - echo "è¿è¡Œéƒ¨ç½²åæµ‹è¯•..."
    - ./ci/post-deployment-tests.sh staging
    - echo "âœ… æµ‹è¯•ç¯å¢ƒHelméƒ¨ç½²å®Œæˆ"
  environment:
    name: staging
    url: https://staging.smarttravel.local
  dependencies:
    - helm_package
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ä½¿ç”¨Helméƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆè“ç»¿éƒ¨ç½²ï¼‰
helm_deploy_production:
  stage: deploy
  image: alpine/helm:latest
  before_script:
    - *common_scripts
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - helm version
    - kubectl version --client
  script:
    - echo "ğŸš€ ä½¿ç”¨Helmè“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    - echo "æ‰§è¡Œæ”¯ä»˜ç³»ç»Ÿç‰¹æ®Šä¿æŠ¤ç­–ç•¥..."
    - ./ci/payment-system-protection.sh pre-deploy
    - kubectl config set-context --current --namespace=$KUBE_NAMESPACE_PROD
    - helm registry login $HARBOR_REGISTRY -u $HARBOR_USERNAME -p $HARBOR_PASSWORD
    - echo "å¼€å§‹è“ç»¿éƒ¨ç½²..."
    - ./ci/helm-blue-green-deployment.sh ${APP_VERSION} ${CI_COMMIT_SHA}
    - echo "éªŒè¯éƒ¨ç½²å’Œç›‘æ§..."
    - ./ci/post-deployment-tests.sh production
    - ./ci/payment-system-protection.sh post-deploy
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒHelmè“ç»¿éƒ¨ç½²å®Œæˆ"
  environment:
    name: production
    url: https://api.smarttravel.com
  dependencies:
    - helm_package
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  timeout: 45m
    DB_HOST: mysql
    DB_PORT: 3306
    DB_USERNAME: root
    DB_PASSWORD: test_password
    DB_DATABASE: smart_travel_test
    NODE_ENV: test
  before_script:
    - echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
    - npm ci --cache .npm --prefer-offline
    - echo "ğŸ—„ï¸ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
    - sleep 10
  script:
    - echo "ğŸ§ª è¿è¡Œç°æœ‰æµ‹è¯•å¥—ä»¶..."
    # é›†æˆç°æœ‰çš„Phase 3Aæµ‹è¯•
    - npm run test:phase3a
    - echo "âœ… Phase 3Aæµ‹è¯•é€šè¿‡"
    
    # è¿è¡Œå•å…ƒæµ‹è¯•
    - npm run test:unit
    - echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
    
    # è¿è¡Œé›†æˆæµ‹è¯•
    - npm run test:integration
    - echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
    
    # ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
    - npm run test:coverage
    - echo "âœ… æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - main
    - develop
    - phase3a-*

# å®‰å…¨æ‰«æé˜¶æ®µ - é›†æˆç°æœ‰å®‰å…¨æµ‹è¯•æ¡†æ¶
security-scan:
  stage: security-scan
  image: node:18-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ”’ è¿è¡Œå®‰å…¨æ‰«æ..."
    
    # é›†æˆç°æœ‰çš„å®‰å…¨æµ‹è¯•
    - npm run test:security
    - echo "âœ… ç°æœ‰å®‰å…¨æµ‹è¯•é€šè¿‡"
    
    # npm audit ä¾èµ–æ¼æ´æ£€æŸ¥
    - npm audit --audit-level=high
    - echo "âœ… ä¾èµ–æ¼æ´æ£€æŸ¥é€šè¿‡"
    
    # ä»£ç å®‰å…¨æ‰«æï¼ˆå¦‚æœé…ç½®äº†SonarQubeï¼‰
    - |
      if [ -n "$SONAR_TOKEN" ]; then
        echo "ğŸ” è¿è¡ŒSonarQubeä»£ç æ‰«æ..."
        npx sonar-scanner
        echo "âœ… ä»£ç å®‰å…¨æ‰«æå®Œæˆ"
      else
        echo "âš ï¸ SonarQubeæœªé…ç½®ï¼Œè·³è¿‡ä»£ç æ‰«æ"
      fi
    
    # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²
    - echo "ğŸ” æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
    - ./scripts/final-security-check.sh
    - echo "âœ… æ•æ„Ÿä¿¡æ¯æ£€æŸ¥é€šè¿‡"
  artifacts:
    reports:
      sast: gl-sast-report.json
    paths:
      - security-scan-results/
    expire_in: 1 week
  allow_failure: false
  only:
    - main
    - develop
    - phase3a-*

# æ„å»ºé˜¶æ®µ - åŸºäºç°æœ‰Dockerfile
build:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "ğŸ³ å‡†å¤‡Dockerç¯å¢ƒ..."
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ğŸ—ï¸ æ„å»ºDockeré•œåƒ..."
    - echo "åŸºäºç°æœ‰Dockerfileæ„å»ºé•œåƒ"
    
    # æ„å»ºåº”ç”¨é•œåƒ
    - docker build -t $IMAGE_TAG .
    - echo "âœ… é•œåƒæ„å»ºå®Œæˆ: $IMAGE_TAG"
    
    # æ¨é€é•œåƒåˆ°ä»“åº“
    - docker push $IMAGE_TAG
    - echo "âœ… é•œåƒæ¨é€å®Œæˆ"
    
    # åˆ›å»ºlatestæ ‡ç­¾ï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $IMAGE_TAG $CI_REGISTRY_IMAGE:latest
        docker push $CI_REGISTRY_IMAGE:latest
        echo "âœ… latestæ ‡ç­¾åˆ›å»ºå®Œæˆ"
      fi
    
    # é•œåƒå®‰å…¨æ‰«æï¼ˆå¦‚æœé…ç½®äº†Trivyï¼‰
    - |
      if command -v trivy >/dev/null 2>&1; then
        echo "ğŸ” è¿è¡Œå®¹å™¨å®‰å…¨æ‰«æ..."
        trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE_TAG
        echo "âœ… å®¹å™¨å®‰å…¨æ‰«æå®Œæˆ"
      else
        echo "âš ï¸ Trivyæœªå®‰è£…ï¼Œè·³è¿‡å®¹å™¨å®‰å…¨æ‰«æ"
      fi
  artifacts:
    paths:
      - docker-scan-results/
    expire_in: 1 week
  only:
    - main
    - develop
    - phase3a-*

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
deploy-staging:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DEPLOY_ENV: staging
  before_script:
    - echo "ğŸš€ å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ..."
    - apk add --no-cache curl
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ğŸ“¦ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
    
    # æ‹‰å–æœ€æ–°é•œåƒ
    - docker pull $IMAGE_TAG
    
    # ä½¿ç”¨ç°æœ‰docker-composeé…ç½®éƒ¨ç½²
    - echo "ä½¿ç”¨ç°æœ‰docker-composeé…ç½®è¿›è¡Œéƒ¨ç½²"
    - export IMAGE_TAG=$IMAGE_TAG
    - docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    - echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
    - sleep 30
    
    # å¥åº·æ£€æŸ¥
    - echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
    - curl -f http://localhost:3000/health
    - echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
    
    # éªŒè¯å…³é”®åŠŸèƒ½
    - echo "ğŸ” éªŒè¯å…³é”®åŠŸèƒ½..."
    - curl -f http://localhost:3000/api/v1/health
    - echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
    
    # éªŒè¯ç›‘æ§æŒ‡æ ‡ç«¯ç‚¹
    - curl -f http://localhost:3000/metrics || echo "âš ï¸ ç›‘æ§æŒ‡æ ‡ç«¯ç‚¹å°†åœ¨ç›‘æ§ç³»ç»Ÿéƒ¨ç½²åå¯ç”¨"
    
  environment:
    name: staging
    url: http://staging.smarttravel.local
  when: manual
  only:
    - develop
    - phase3a-*

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy-production:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DEPLOY_ENV: production
  before_script:
    - echo "ğŸš€ å‡†å¤‡ç”Ÿäº§éƒ¨ç½²..."
    - apk add --no-cache curl
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "ğŸ­ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    
    # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰æ£€æŸ¥
    - echo "ğŸ” ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰æ£€æŸ¥..."
    - docker pull $IMAGE_TAG
    
    # è“ç»¿éƒ¨ç½²ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    - echo "ğŸ”„ æ‰§è¡Œè“ç»¿éƒ¨ç½²..."
    - export IMAGE_TAG=$IMAGE_TAG
    - docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d
    
    # ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
    - echo "ğŸ¥ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥..."
    - sleep 60  # ç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´é•¿å¯åŠ¨æ—¶é—´
    - curl -f http://localhost:3000/health
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
    
    # å…³é”®ä¸šåŠ¡åŠŸèƒ½éªŒè¯
    - echo "ğŸ’¼ å…³é”®ä¸šåŠ¡åŠŸèƒ½éªŒè¯..."
    - curl -f http://localhost:3000/api/v1/health
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
    
  environment:
    name: production
    url: https://smarttravel.com
  when: manual
  only:
    - main

# éƒ¨ç½²åéªŒè¯
post-deploy-verification:
  stage: deploy
  image: node:18-alpine
  script:
    - echo "âœ… éƒ¨ç½²åéªŒè¯..."
    - apk add --no-cache curl
    
    # éªŒè¯åº”ç”¨å“åº”
    - curl -f http://localhost:3000/health
    
    # éªŒè¯å…³é”®APIç«¯ç‚¹
    - curl -f http://localhost:3000/api/v1/health
    
    # éªŒè¯æ•°æ®åº“è¿æ¥
    - curl -f http://localhost:3000/api/v1/status/database
    
    # éªŒè¯Redisè¿æ¥
    - curl -f http://localhost:3000/api/v1/status/redis
    
    # éªŒè¯æ”¯ä»˜ç³»ç»ŸçŠ¶æ€ï¼ˆåŸºäºéš”ç¦»å¼æ”¯ä»˜éªŒè¯æ¶æ„ï¼‰
    - curl -f http://localhost:3000/api/v1/status/payment
    
    echo "ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œéƒ¨ç½²æˆåŠŸï¼"
  when: on_success
  only:
    - main
    - develop
