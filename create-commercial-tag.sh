#!/bin/bash

# æ™ºæ¸¸åŠ©æ‰‹v6.2 å•†ä¸šåŒ–å°±ç»ªåº¦è¯„ä¼°æ ‡ç­¾åˆ›å»ºè„šæœ¬
# ä¸ºå½“å‰ä»£ç çŠ¶æ€åˆ›å»ºGitæ ‡ç­¾

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_header() {
    echo -e "${CYAN}$1${NC}"
}

# æ ‡ç­¾ä¿¡æ¯
TAG_NAME="v6.2-commercial-ready-assessment"
TAG_MESSAGE="æ™ºæ¸¸åŠ©æ‰‹v6.2å•†ä¸šåŒ–å°±ç»ªåº¦è¯„ä¼°ç‰ˆæœ¬

å•†ä¸šåŒ–å°±ç»ªåº¦: 45%å®Œæˆ
- åŸºç¡€è®¾æ–½: 95%å®Œæˆ âœ…
- CI/CD Pipeline: 100%å®Œæˆ âœ…  
- ç›‘æŽ§ç³»ç»Ÿ: 100%å®Œæˆ âœ…
- ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ: 30%å®Œæˆ ðŸ”„
- æ”¯ä»˜ç³»ç»Ÿ: 40%å®Œæˆ ðŸ”„
- æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½: 20%å®Œæˆ ðŸ”„

P0çº§å…³é”®ç¼ºå¤±åŠŸèƒ½:
1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿå®Œå–„ (é¢„è®¡2å‘¨)
2. æ”¯ä»˜ç³»ç»Ÿå®‰å…¨åŠ å›º (é¢„è®¡1å‘¨)  
3. æ ¸å¿ƒæŽ¨èç®—æ³•å®žçŽ° (é¢„è®¡3å‘¨)

é¢„è®¡å•†ä¸šåŒ–æ—¶é—´: 4-6å‘¨
è¯„ä¼°æ—¶é—´: 2024å¹´1æœˆ8æ—¥"

BRANCH_NAME="feature/commercialization"

main() {
    log_header "ðŸ·ï¸ æ™ºæ¸¸åŠ©æ‰‹v6.2 å•†ä¸šåŒ–å°±ç»ªåº¦è¯„ä¼°æ ‡ç­¾åˆ›å»º"
    log_header "============================================="
    echo ""
    
    # æ£€æŸ¥GitçŠ¶æ€
    log_info "1ï¸âƒ£ æ£€æŸ¥Gitä»“åº“çŠ¶æ€..."
    
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        log_error "âŒ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“"
        exit 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
    if ! git diff-index --quiet HEAD --; then
        log_warning "âš ï¸ æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹"
        echo ""
        git status --porcelain
        echo ""
        read -p "æ˜¯å¦ç»§ç»­åˆ›å»ºæ ‡ç­¾? (y/N): " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "æ“ä½œå·²å–æ¶ˆ"
            exit 0
        fi
    fi
    
    # æ˜¾ç¤ºå½“å‰åˆ†æ”¯
    current_branch=$(git branch --show-current)
    log_info "å½“å‰åˆ†æ”¯: $current_branch"
    
    # åˆ›å»ºå¹¶æŽ¨é€æ ‡ç­¾
    log_info "2ï¸âƒ£ åˆ›å»ºGitæ ‡ç­¾..."
    
    # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
    if git tag -l | grep -q "^$TAG_NAME$"; then
        log_warning "âš ï¸ æ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨"
        read -p "æ˜¯å¦åˆ é™¤çŽ°æœ‰æ ‡ç­¾å¹¶é‡æ–°åˆ›å»º? (y/N): " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git tag -d "$TAG_NAME"
            log_info "å·²åˆ é™¤çŽ°æœ‰æ ‡ç­¾"
        else
            log_info "æ“ä½œå·²å–æ¶ˆ"
            exit 0
        fi
    fi
    
    # åˆ›å»ºå¸¦æ³¨é‡Šçš„æ ‡ç­¾
    git tag -a "$TAG_NAME" -m "$TAG_MESSAGE"
    log_success "âœ… æ ‡ç­¾ $TAG_NAME åˆ›å»ºæˆåŠŸ"
    
    # åˆ›å»ºå•†ä¸šåŒ–å¼€å‘åˆ†æ”¯
    log_info "3ï¸âƒ£ åˆ›å»ºå•†ä¸šåŒ–å¼€å‘åˆ†æ”¯..."
    
    if git branch -l | grep -q "$BRANCH_NAME"; then
        log_warning "âš ï¸ åˆ†æ”¯ $BRANCH_NAME å·²å­˜åœ¨"
        read -p "æ˜¯å¦åˆ‡æ¢åˆ°çŽ°æœ‰åˆ†æ”¯? (y/N): " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git checkout "$BRANCH_NAME"
            log_success "âœ… å·²åˆ‡æ¢åˆ°åˆ†æ”¯ $BRANCH_NAME"
        fi
    else
        git checkout -b "$BRANCH_NAME"
        log_success "âœ… åˆ†æ”¯ $BRANCH_NAME åˆ›å»ºæˆåŠŸ"
    fi
    
    # æ˜¾ç¤ºæ ‡ç­¾ä¿¡æ¯
    log_info "4ï¸âƒ£ æ ‡ç­¾ä¿¡æ¯ç¡®è®¤..."
    echo ""
    log_header "ðŸ“‹ æ ‡ç­¾è¯¦æƒ…:"
    echo "æ ‡ç­¾åç§°: $TAG_NAME"
    echo "åˆ›å»ºæ—¶é—´: $(date)"
    echo "æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"
    echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
    echo ""
    
    log_header "ðŸ“ æ ‡ç­¾æ¶ˆæ¯:"
    echo "$TAG_MESSAGE"
    echo ""
    
    # æŽ¨é€é€‰é¡¹
    log_info "5ï¸âƒ£ æŽ¨é€åˆ°è¿œç¨‹ä»“åº“..."
    
    read -p "æ˜¯å¦æŽ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“? (y/N): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # æ£€æŸ¥è¿œç¨‹ä»“åº“
        if git remote | grep -q origin; then
            git push origin "$TAG_NAME"
            log_success "âœ… æ ‡ç­¾å·²æŽ¨é€åˆ°è¿œç¨‹ä»“åº“"
            
            # æŽ¨é€åˆ†æ”¯
            read -p "æ˜¯å¦æŽ¨é€å•†ä¸šåŒ–å¼€å‘åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“? (y/N): " -n 1 -r
            echo ""
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                git push origin "$BRANCH_NAME"
                log_success "âœ… åˆ†æ”¯å·²æŽ¨é€åˆ°è¿œç¨‹ä»“åº“"
            fi
        else
            log_warning "âš ï¸ æœªæ‰¾åˆ°è¿œç¨‹ä»“åº“ origin"
        fi
    fi
    
    # ç”Ÿæˆæ ‡ç­¾æŠ¥å‘Š
    log_info "6ï¸âƒ£ ç”Ÿæˆæ ‡ç­¾æŠ¥å‘Š..."
    
    cat > "TAG_REPORT_${TAG_NAME}.md" << EOF
# Gitæ ‡ç­¾æŠ¥å‘Š: $TAG_NAME

## ðŸ“… åˆ›å»ºæ—¶é—´
$(date)

## ðŸ“Š é¡¹ç›®çŠ¶æ€
- **ç‰ˆæœ¬**: v6.2.0
- **å•†ä¸šåŒ–å°±ç»ªåº¦**: 45%
- **æäº¤å“ˆå¸Œ**: $(git rev-parse HEAD)
- **åˆ†æ”¯**: $(git branch --show-current)

## âœ… å·²å®ŒæˆåŠŸèƒ½
- åŸºç¡€è®¾æ–½: 95%å®Œæˆ (GitLab CE + Harbor + K3s + ç›‘æŽ§ç³»ç»Ÿ)
- CI/CD Pipeline: 100%å®Œæˆ (äº”é˜¶æ®µæµæ°´çº¿ + è“ç»¿éƒ¨ç½² + é‡‘ä¸é›€å‘å¸ƒ)
- ç›‘æŽ§ç³»ç»Ÿ: 100%å®Œæˆ (Prometheus + Grafana + å®Œæ•´å‘Šè­¦ä½“ç³»)

## ðŸ”„ è¿›è¡Œä¸­åŠŸèƒ½
- ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ: 30%å®Œæˆ (MCPæž¶æž„ + åŸºç¡€APIï¼Œç¼ºJWTè®¤è¯)
- æ”¯ä»˜ç³»ç»Ÿ: 40%å®Œæˆ (å¾®ä¿¡æ”¯ä»˜é›†æˆï¼Œç¼ºæ”¯ä»˜å®å’Œå®‰å…¨åŠ å›º)
- æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½: 20%å®Œæˆ (UIå®Œæ•´ï¼Œç¼ºæŽ¨èç®—æ³•å’Œå®žæ—¶æ•°æ®)

## ðŸš¨ P0çº§å…³é”®ç¼ºå¤±åŠŸèƒ½
1. **ç”¨æˆ·è®¤è¯ç³»ç»Ÿå®Œå–„** (é¢„è®¡2å‘¨)
   - JWTè®¤è¯æœºåˆ¶
   - å¯†ç åŠ å¯†å­˜å‚¨
   - ç”¨æˆ·åå¥½ç®¡ç†

2. **æ”¯ä»˜ç³»ç»Ÿå®‰å…¨åŠ å›º** (é¢„è®¡1å‘¨)
   - æ”¯ä»˜æ•°æ®åŠ å¯†
   - æ”¯ä»˜å®é›†æˆ
   - é€€æ¬¾åŠŸèƒ½

3. **æ ¸å¿ƒæŽ¨èç®—æ³•å®žçŽ°** (é¢„è®¡3å‘¨)
   - æ™ºèƒ½æŽ¨èå¼•æ“Ž
   - å®žæ—¶æ•°æ®é›†æˆ
   - é¢„è®¢åŠŸèƒ½é›†æˆ

## ðŸŽ¯ ä¸‹ä¸€æ­¥è®¡åˆ’
- ç«‹å³å¼€å§‹P0çº§åŠŸèƒ½å¼€å‘
- é¢„è®¡4-6å‘¨è¾¾åˆ°95%å•†ä¸šåŒ–å°±ç»ªåº¦
- ç›®æ ‡æ­£å¼å•†ä¸šåŒ–ä¸Šçº¿æ—¶é—´: 2024å¹´2æœˆ

## ðŸ“‹ ç›¸å…³æ–‡æ¡£
- PROJECT_STATUS.md - è¯¦ç»†é¡¹ç›®çŠ¶æ€åˆ†æž
- immediate-action-plan-v6.2.md - å•†ä¸šåŒ–å¼€å‘è·¯çº¿å›¾
- CHANGELOG.md - å®Œæ•´æ›´æ–°æ—¥å¿—

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*
EOF
    
    log_success "âœ… æ ‡ç­¾æŠ¥å‘Šå·²ç”Ÿæˆ: TAG_REPORT_${TAG_NAME}.md"
    
    echo ""
    log_header "ðŸŽ‰ æ ‡ç­¾åˆ›å»ºå®Œæˆï¼"
    echo ""
    log_info "ðŸ“‹ åˆ›å»ºçš„èµ„æº:"
    echo "   â€¢ Gitæ ‡ç­¾: $TAG_NAME"
    echo "   â€¢ å¼€å‘åˆ†æ”¯: $BRANCH_NAME"
    echo "   â€¢ æ ‡ç­¾æŠ¥å‘Š: TAG_REPORT_${TAG_NAME}.md"
    echo ""
    log_info "ðŸš€ ä¸‹ä¸€æ­¥å»ºè®®:"
    echo "   1. æŸ¥çœ‹æ ‡ç­¾æŠ¥å‘Šäº†è§£è¯¦ç»†çŠ¶æ€"
    echo "   2. å¼€å§‹æ‰§è¡Œå•†ä¸šåŒ–å¼€å‘è®¡åˆ’"
    echo "   3. å®šæœŸæ›´æ–°é¡¹ç›®çŠ¶æ€æ–‡æ¡£"
    echo ""
    log_success "æ™ºæ¸¸åŠ©æ‰‹v6.2å•†ä¸šåŒ–å°±ç»ªåº¦è¯„ä¼°æ ‡ç­¾åˆ›å»ºæˆåŠŸï¼"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
