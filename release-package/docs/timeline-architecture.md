# Timelineè§£ææ¶æ„v2.0æŠ€æœ¯æ–‡æ¡£

## ğŸ¯ æ¶æ„æ¦‚è¿°

Timelineè§£ææ¶æ„v2.0æ˜¯æ™ºæ¸¸åŠ©æ‰‹v6.5çš„æ ¸å¿ƒç»„ä»¶ï¼Œé‡‡ç”¨å¯æ’æ‹”çš„è§£æå™¨ç³»ç»Ÿï¼Œå®ç°äº†å¯¹å¤šç§LLMè¾“å‡ºæ ¼å¼çš„æ™ºèƒ½è§£æå’Œæ ‡å‡†åŒ–å¤„ç†ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Timelineè§£ææ¶æ„v2.0                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LLMè¾“å‡º â†’ Orchestrator â†’ è§£æå™¨é€‰æ‹© â†’ æ•°æ®è§„èŒƒåŒ– â†’ å‰ç«¯æ¸²æŸ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLMåŸå§‹è¾“å‡º     â”‚    â”‚   æ ¸å¿ƒè°ƒåº¦å™¨      â”‚    â”‚   æ ‡å‡†åŒ–æ•°æ®      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ JSONæ ¼å¼      â”‚â”€â”€â”€â–¶â”‚ â€¢ è§£æå™¨æ³¨å†Œ     â”‚â”€â”€â”€â–¶â”‚ â€¢ DayPlan[]     â”‚
â”‚ â€¢ Markdownæ ¼å¼  â”‚    â”‚ â€¢ ä¼˜å…ˆçº§ç®¡ç†     â”‚    â”‚ â€¢ LegacyFormat  â”‚
â”‚ â€¢ æ•°å­—åˆ—è¡¨æ ¼å¼   â”‚    â”‚ â€¢ é”™è¯¯å¤„ç†      â”‚    â”‚ â€¢ å‰ç«¯å…¼å®¹      â”‚
â”‚ â€¢ è‡ªç”±æ–‡æœ¬æ ¼å¼   â”‚    â”‚ â€¢ æ€§èƒ½ç›‘æ§      â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      è§£æå™¨æ’ä»¶ç³»ç»Ÿ       â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ JsonParser (ä¼˜å…ˆçº§100)   â”‚
                    â”‚ MarkdownParser (ä¼˜å…ˆçº§80) â”‚
                    â”‚ NumberedParser (ä¼˜å…ˆçº§70) â”‚
                    â”‚ HeuristicParser (ä¼˜å…ˆçº§10)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

1. **LLMè¾“å‡º** â†’ åŸå§‹æ–‡æœ¬æ•°æ®
2. **Orchestrator** â†’ è°ƒåº¦å™¨åˆ†æå†…å®¹æ ¼å¼
3. **è§£æå™¨é€‰æ‹©** â†’ æ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©æœ€é€‚åˆçš„è§£æå™¨
4. **æ•°æ®è§£æ** â†’ å°†åŸå§‹æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„åŒ–æ•°æ®
5. **æ•°æ®è§„èŒƒåŒ–** â†’ ç»Ÿä¸€æ•°æ®æ ¼å¼å’ŒéªŒè¯
6. **å‰ç«¯æ¸²æŸ“** â†’ æ ‡å‡†åŒ–æ•°æ®ä¼ é€’ç»™å‰ç«¯ç»„ä»¶

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. TimelineOrchestrator (æ ¸å¿ƒè°ƒåº¦å™¨)

```typescript
class TimelineOrchestrator {
  // è§£æTimelineå†…å®¹çš„ä¸»å…¥å£
  async parseTimeline(raw: string, context: ParseContext): Promise<ParseResult>
  
  // è½¬æ¢ä¸ºå…¼å®¹æ ¼å¼
  async parseTimelineToLegacyFormat(raw: string, context: ParseContext): Promise<LegacyDayActivity[]>
}
```

**èŒè´£**ï¼š
- ç®¡ç†è§£æå™¨æ’ä»¶çš„æ³¨å†Œå’Œè°ƒåº¦
- æ ¹æ®å†…å®¹ç‰¹å¾é€‰æ‹©æœ€é€‚åˆçš„è§£æå™¨
- å¤„ç†è§£æå¤±è´¥çš„é™çº§é€»è¾‘
- æ”¶é›†æ€§èƒ½æŒ‡æ ‡å’Œé”™è¯¯æ—¥å¿—

### 2. è§£æå™¨æ’ä»¶ç³»ç»Ÿ

#### JsonParser (ä¼˜å…ˆçº§: 100)
- **é€‚ç”¨åœºæ™¯**: LLMè¾“å‡ºåŒ…å«JSONç»“æ„
- **æ£€æµ‹æ¡ä»¶**: åŒ…å«`{}`ã€`"days"`ã€`"day"`æˆ–````json`
- **è§£æç­–ç•¥**: æå–JSONå¹¶éªŒè¯Schema

#### MarkdownPeriodParser (ä¼˜å…ˆçº§: 80)
- **é€‚ç”¨åœºæ™¯**: Markdownæ ¼å¼çš„æ—¶é—´æ®µè¾“å‡º
- **æ£€æµ‹æ¡ä»¶**: åŒ…å«æ—¶é—´æ®µæ ‡è®°å’ŒMarkdownç»“æ„
- **è§£æç­–ç•¥**: è§£æMarkdownæ ‡é¢˜å’Œæ—¶é—´æ®µ

#### NumberedListParser (ä¼˜å…ˆçº§: 70)
- **é€‚ç”¨åœºæ™¯**: æ•°å­—åˆ—è¡¨æ ¼å¼çš„è¾“å‡º
- **æ£€æµ‹æ¡ä»¶**: åŒ…å«æ•°å­—åˆ—è¡¨æ ‡è®°
- **è§£æç­–ç•¥**: è§£ææ•°å­—åˆ—è¡¨ç»“æ„

#### HeuristicTimeParser (ä¼˜å…ˆçº§: 10)
- **é€‚ç”¨åœºæ™¯**: å…œåº•è§£æå™¨ï¼Œå¤„ç†ä»»æ„æ ¼å¼
- **æ£€æµ‹æ¡ä»¶**: å†…å®¹é•¿åº¦>50å­—ç¬¦
- **è§£æç­–ç•¥**: å¯å‘å¼è§„åˆ™è§£æ

### 3. æ•°æ®è§„èŒƒåŒ–å±‚ (Normalizer)

```typescript
// è§„èŒƒåŒ–å‡½æ•°
export function normalizeLLMOutput(data: any, context: ParseContext): DayPlan[]
export function convertToLegacyFormat(dayPlans: DayPlan[]): LegacyDayActivity[]
```

**èŒè´£**ï¼š
- å°†ä¸åŒè§£æå™¨çš„è¾“å‡ºç»Ÿä¸€ä¸ºDayPlanæ ¼å¼
- æ•°æ®éªŒè¯å’Œæ¸…æ´—
- ç”Ÿæˆå‰ç«¯å…¼å®¹çš„LegacyFormatæ•°æ®
- æ·»åŠ é»˜è®¤å€¼å’Œè®¡ç®—å­—æ®µ

### 4. SchemaéªŒè¯å™¨

```typescript
// Zod Schemaå®šä¹‰
export const DayPlanSchema = z.object({
  day: z.number().int().positive(),
  title: z.string().min(1),
  date: z.string(),
  segments: z.array(SegmentSchema).min(1)
});
```

**èŒè´£**ï¼š
- éªŒè¯è§£æç»“æœçš„æ•°æ®ç»“æ„
- æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- ç¡®ä¿æ•°æ®ç±»å‹å®‰å…¨

## ğŸš€ Feature Flagç³»ç»Ÿ

### é…ç½®é€‰é¡¹

```typescript
interface FeatureFlags {
  TIMELINE_V2_ENABLED: boolean;        // å…¨å±€å¼€å…³
  TIMELINE_V2_PERCENTAGE: number;      // æµé‡ç™¾åˆ†æ¯” (0-100)
  TIMELINE_V2_WHITELIST: string[];     // ç™½åå•sessionId
  TIMELINE_V2_BLACKLIST: string[];     // é»‘åå•sessionId
}
```

### ä½¿ç”¨æ–¹å¼

```typescript
// æ£€æŸ¥æ˜¯å¦å¯ç”¨Timeline v2.0
const enabled = isTimelineV2Enabled(sessionId);

// ç¯å¢ƒå˜é‡é…ç½®
TIMELINE_V2_ENABLED=true
TIMELINE_V2_PERCENTAGE=100
TIMELINE_V2_WHITELIST=session_123,session_456
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- **è§£ææ—¶é—´**: <500ms (ç›®æ ‡)
- **è§£ææˆåŠŸç‡**: >99% (ç›®æ ‡)
- **å‰ç«¯æ¸²æŸ“æ—¶é—´**: <200ms (ç›®æ ‡)
- **å†…å­˜ä½¿ç”¨**: <50MB (å•æ¬¡è§£æ)

### ç›‘æ§å®ç°

```typescript
// æ€§èƒ½ç›‘æ§åŸ‹ç‚¹
console.log('[MONITOR] Timelineè§£æ', {
  sessionId,
  parseSuccess: result.success,
  parseTime: Date.now() - startTime,
  parser: result.parser,
  daysCount: result.data?.length || 0
});
```

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ç”¨æ³•

```typescript
import { parseTimelineToLegacy, createParseContext } from '@/lib/timeline';

// åˆ›å»ºè§£æä¸Šä¸‹æ–‡
const context = createParseContext(
  destination,    // ç›®çš„åœ°
  totalDays,     // æ€»å¤©æ•°
  sessionId,     // ä¼šè¯ID
  startDate      // å¼€å§‹æ—¥æœŸ
);

// è§£æTimeline
const legacyFormat = await parseTimelineToLegacy(llmResponse, context);
```

### å‰ç«¯é›†æˆ

```typescript
// APIå“åº”åŒ…å«legacyFormat
const response = await fetch(`/api/v1/planning/sessions/${sessionId}`);
const { data } = await response.json();

// å‰ç«¯ç»„ä»¶ä½¿ç”¨legacyFormat
<DailyItinerarySection
  legacyFormat={data.legacyFormat}
  startDate={data.startDate}
  totalDays={data.totalDays}
/>
```

## ğŸ› ï¸ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°è§£æå™¨

```typescript
class CustomParser extends BaseParser {
  name = 'CustomParser';
  priority = 60; // è®¾ç½®ä¼˜å…ˆçº§
  
  canHandle(raw: string): boolean {
    // æ£€æµ‹é€»è¾‘
    return raw.includes('custom-format');
  }
  
  async tryParse(raw: string, context: ParseContext): Promise<DayPlan[] | null> {
    // è§£æé€»è¾‘
    return parsedData;
  }
}

// æ³¨å†Œè§£æå™¨
parserRegistry.register(new CustomParser());
```

### è‡ªå®šä¹‰è§„èŒƒåŒ–

```typescript
export function normalizeCustomOutput(data: any, context: ParseContext): DayPlan[] {
  // è‡ªå®šä¹‰è§„èŒƒåŒ–é€»è¾‘
  return normalizedData;
}
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **è§£æå¤±è´¥**: æ£€æŸ¥LLMè¾“å‡ºæ ¼å¼ï¼ŒæŸ¥çœ‹è§£æå™¨æ—¥å¿—
2. **æ•°æ®ä¸å®Œæ•´**: éªŒè¯è§„èŒƒåŒ–è¿‡ç¨‹ï¼Œæ£€æŸ¥SchemaéªŒè¯
3. **æ€§èƒ½é—®é¢˜**: æŸ¥çœ‹è§£ææ—¶é—´ç›‘æ§ï¼Œä¼˜åŒ–è§£æé€»è¾‘

### è°ƒè¯•å·¥å…·

```typescript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
process.env.TIMELINE_DEBUG = 'true';

// æŸ¥çœ‹è§£æå™¨é€‰æ‹©è¿‡ç¨‹
const capableParsers = parserRegistry.getCapable(raw);
console.log('å¯ç”¨è§£æå™¨:', capableParsers.map(p => p.name));
```

## ğŸ“ˆ ç‰ˆæœ¬å†å²

### v2.0.0 (2025-01-09)
- âœ¨ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- ğŸ”§ å¯æ’æ‹”è§£æå™¨ç³»ç»Ÿ
- âš¡ Feature Flagæ”¯æŒ
- ğŸ“Š å®Œæ•´ç›‘æ§å’Œæ—¥å¿—

### æœªæ¥è§„åˆ’
- v2.1.0: å¢åŠ æ›´å¤šè§£æå™¨æ’ä»¶
- v2.2.0: æ”¯æŒè‡ªå®šä¹‰è§£æè§„åˆ™
- v2.3.0: æœºå™¨å­¦ä¹ è¾…åŠ©è§£æä¼˜åŒ–
