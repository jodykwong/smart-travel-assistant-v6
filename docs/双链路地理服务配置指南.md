# 智游助手双链路地理服务配置指南

**版本**: v1.0  
**更新日期**: 2025年8月5日  
**适用版本**: 智游助手 v6.2+  

---

## 📋 概述

智游助手采用双链路冗余架构来确保地理数据服务的高可用性。通过配置高德地图MCP作为主链路，腾讯地图MCP作为备用链路，实现99.5%以上的服务可用性。

### 架构设计原则

- **质量优先**: 备用服务必须提供与主服务相同质量的数据
- **智能切换**: 基于服务质量自动切换，而非简单的故障切换
- **透明操作**: 用户无感知的服务切换
- **实时监控**: 持续监控服务质量和可用性

---

## 🔧 环境变量配置

### 主链路配置 (高德地图MCP)

```bash
# 高德MCP服务配置
AMAP_MCP_SERVER_URL=https://mcp.amap.com/sse
AMAP_MCP_API_KEY=your_amap_api_key_here
MCP_AMAP_ENABLED=true
```

### 备用链路配置 (腾讯地图MCP)

```bash
# 腾讯地图MCP服务配置
TENCENT_MCP_SERVER_URL=https://apis.map.qq.com/mcp/sse
TENCENT_MCP_API_KEY=ZV3BZ-YW6W5-C6EIT-IRXQV-WZ5O2-S3FAU
MCP_TENCENT_ENABLED=true

# 腾讯地图WebService API配置
TENCENT_WEBSERVICE_BASE_URL=https://apis.map.qq.com/ws
TENCENT_WEBSERVICE_API_KEY=ZV3BZ-YW6W5-C6EIT-IRXQV-WZ5O2-S3FAU
TENCENT_FALLBACK_TO_WEBSERVICE=true
```

### 双链路策略配置

```bash
# 地理服务策略
GEO_SERVICE_STRATEGY=dual_redundancy
GEO_PRIMARY_PROVIDER=amap
GEO_SECONDARY_PROVIDER=tencent

# 质量控制阈值
GEO_QUALITY_THRESHOLD=0.9          # 服务质量阈值 (90%)
GEO_RESPONSE_TIME_THRESHOLD=10000   # 响应时间阈值 (10秒)
GEO_ACCURACY_THRESHOLD=0.95         # 数据准确性阈值 (95%)

# 自动切换配置
GEO_AUTO_SWITCH_ENABLED=true        # 启用自动切换
GEO_SWITCH_COOLDOWN=300000          # 切换冷却时间 (5分钟)
GEO_HEALTH_CHECK_INTERVAL=60000     # 健康检查间隔 (1分钟)
```

---

## 🚀 使用方法

### 1. 配置验证

运行配置验证脚本确保所有配置正确：

```bash
node scripts/verify-geo-services.js
```

### 2. 代码中使用

```typescript
import { UnifiedGeoService } from '@/services/geo/UnifiedGeoService';

// 初始化统一地理服务
const geoService = new UnifiedGeoService({
  amap: {
    apiKey: process.env.AMAP_MCP_API_KEY,
    serverUrl: process.env.AMAP_MCP_SERVER_URL
  },
  tencent: {
    apiKey: process.env.TENCENT_MCP_API_KEY,
    serverUrl: process.env.TENCENT_MCP_SERVER_URL
  },
  strategy: process.env.GEO_SERVICE_STRATEGY
});

// 使用地理编码服务 (自动选择最佳服务)
const result = await geoService.geocoding('北京市朝阳区');

// 使用路线规划服务
const route = await geoService.routePlanning(
  '116.397428,39.90923',  // 起点
  '116.427428,39.92923',  // 终点
  'driving'               // 驾车模式
);
```

### 3. 服务质量监控

```typescript
// 获取服务质量报告
const qualityReport = await geoService.getQualityReport();
console.log('服务质量报告:', qualityReport);

// 手动切换服务
await geoService.switchToSecondary();

// 重置为自动模式
await geoService.resetToAuto();
```

---

## 📊 服务对比

### 功能对等性

| 功能 | 高德地图MCP | 腾讯地图MCP | 状态 |
|------|-------------|-------------|------|
| 地理编码 | ✅ | ✅ | 完全对等 |
| 逆地理编码 | ✅ | ✅ | 完全对等 |
| POI搜索 | ✅ | ✅ | 完全对等 |
| 周边搜索 | ✅ | ✅ | 完全对等 |
| 路线规划 | ✅ | ✅ | 完全对等 |
| 距离计算 | ✅ | ✅ | 完全对等 |
| IP定位 | ✅ | ✅ | 完全对等 |
| 天气查询 | ✅ | ✅ | 完全对等 |
| 专属地图 | ✅ | ❌ | 高德独有 |
| 沿途搜索 | ❌ | ✅ | 腾讯独有 |

### 数据质量对比

| 指标 | 高德地图 | 腾讯地图 | 说明 |
|------|----------|----------|------|
| 覆盖范围 | 99%+ | 98%+ | 中国大陆 |
| POI数量 | 1.2亿+ | 1亿+ | 兴趣点数据 |
| 更新频率 | <24小时 | <48小时 | 道路变化同步 |
| 导航准确率 | 95%+ | 93%+ | 路线规划准确性 |

---

## ⚠️ 注意事项

### 1. API密钥管理

- **安全存储**: 不要将API密钥提交到版本控制系统
- **定期轮换**: 建议每6个月更换一次API密钥
- **权限控制**: 为不同环境使用不同的API密钥

### 2. 成本控制

- **智能切换**: 备用服务仅在主服务不可用时使用
- **监控用量**: 定期检查API调用量和费用
- **缓存策略**: 合理使用缓存减少API调用

### 3. 服务限制

- **调用频率**: 遵守各服务商的调用频率限制
- **数据使用**: 遵守数据使用协议和条款
- **地域限制**: 注意服务的地理覆盖范围

---

## 🔍 故障排查

### 常见问题

**1. 服务连接失败**
```bash
# 检查网络连接
curl -I https://mcp.amap.com/sse
curl -I https://apis.map.qq.com/mcp/sse

# 检查API密钥
node scripts/verify-geo-services.js
```

**2. 数据质量异常**
```bash
# 查看服务质量日志
tail -f logs/geo-service-quality.log

# 手动测试API
node scripts/test-geo-apis.js
```

**3. 自动切换不工作**
```bash
# 检查切换配置
grep GEO_AUTO_SWITCH .env.local

# 查看切换日志
tail -f logs/geo-service-switch.log
```

### 调试模式

启用调试模式获取详细日志：

```bash
# 设置调试环境变量
export DEBUG=geo-service:*
export LOG_LEVEL=debug

# 启动应用
npm run dev
```

---

## 📈 性能优化

### 1. 缓存策略

```typescript
// 配置缓存
const cacheConfig = {
  geocoding: { ttl: 3600 },      // 地理编码缓存1小时
  reverseGeocoding: { ttl: 1800 }, // 逆地理编码缓存30分钟
  poiSearch: { ttl: 600 },       // POI搜索缓存10分钟
  routing: { ttl: 300 }          // 路线规划缓存5分钟
};
```

### 2. 并发控制

```typescript
// 限制并发请求数
const concurrencyConfig = {
  maxConcurrent: 10,             // 最大并发数
  queueTimeout: 30000,           // 队列超时时间
  retryAttempts: 3               // 重试次数
};
```

### 3. 预热机制

```typescript
// 服务预热
await geoService.warmup([
  { type: 'geocoding', params: { address: '北京市' } },
  { type: 'poiSearch', params: { keywords: '餐厅' } }
]);
```

---

## 📞 技术支持

### 联系方式

- **技术文档**: [项目Wiki](./README.md)
- **问题反馈**: [GitHub Issues](https://github.com/your-repo/issues)
- **技术讨论**: 项目技术群

### 相关文档

- [高德地图MCP官方文档](https://lbs.amap.com/api/mcp-server)
- [腾讯地图MCP官方文档](https://lbs.qq.com/service/MCPServer)
- [智游助手架构设计文档](./智游助手v6.2技术评估与商业化战略.md)

---

**最后更新**: 2025年8月5日  
**维护者**: 智游助手技术团队  
