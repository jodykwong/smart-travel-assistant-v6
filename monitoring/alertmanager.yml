# æ™ºæ¸¸åŠ©æ‰‹v6.2 AlertManageré…ç½®
# åŸºäºç°æœ‰æ¶æ„çš„æ™ºèƒ½å‘Šè­¦ç®¡ç†

global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@smarttravel.com'
  smtp_auth_username: 'alerts@smarttravel.com'
  smtp_auth_password: 'your_app_password'
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    # å…³é”®å‘Šè­¦è·¯ç”±
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 5m
      routes:
        # æ”¯ä»˜ç³»ç»Ÿå…³é”®å‘Šè­¦
        - match:
            service: payment
          receiver: 'payment-critical'
        # åº”ç”¨æœåŠ¡å…³é”®å‘Šè­¦
        - match:
            service: smart-travel
          receiver: 'app-critical'

    # æ”¯ä»˜å›¢é˜Ÿå‘Šè­¦è·¯ç”±
    - match:
        team: payment
      receiver: 'payment-team'
      group_by: ['alertname', 'service']

    # åç«¯å›¢é˜Ÿå‘Šè­¦è·¯ç”±
    - match:
        team: backend
      receiver: 'backend-team'
      group_by: ['alertname', 'service']

    # å¹³å°å›¢é˜Ÿå‘Šè­¦è·¯ç”±
    - match:
        team: platform
      receiver: 'platform-team'
      group_by: ['alertname', 'service']

    # äº§å“å›¢é˜Ÿå‘Šè­¦è·¯ç”±
    - match:
        team: product
      receiver: 'product-team'
      group_by: ['alertname', 'service']

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡ä¸‹çº¿ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: SmartTravelServiceDown
    target_match_re:
      alertname: (SmartTravelHighErrorRate|SmartTravelHighResponseTime|PaymentSuccessRateLow)
    equal: ['service']

  # å¦‚æœæ•°æ®åº“ä¸‹çº¿ï¼ŒæŠ‘åˆ¶æ•°æ®åº“ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: MySQLConnectionsHigh
    target_match_re:
      alertname: (MySQLSlowQueries)
    equal: ['instance']

  # å¦‚æœç³»ç»Ÿèµ„æºå‘Šè­¦ï¼ŒæŠ‘åˆ¶åº”ç”¨æ€§èƒ½å‘Šè­¦
  - source_match_re:
      alertname: (HighCPUUsage|HighMemoryUsage)
    target_match:
      alertname: SmartTravelHighResponseTime
    equal: ['instance']

# å‘Šè­¦æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    slack_configs:
      - channel: '#alerts'
        title: 'æ™ºæ¸¸åŠ©æ‰‹v6.2 å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **æœåŠ¡**: {{ .Labels.service }}
          **ä¸¥é‡ç¨‹åº¦**: {{ .Labels.severity }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}**å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true

  # å…³é”®å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    slack_configs:
      - channel: '#critical-alerts'
        title: 'ğŸš¨ CRITICAL: æ™ºæ¸¸åŠ©æ‰‹v6.2 å…³é”®å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **ğŸš¨ å…³é”®å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **æœåŠ¡**: {{ .Labels.service }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}**ç´§æ€¥å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true
        color: 'danger'
    email_configs:
      - to: 'oncall@smarttravel.com'
        subject: 'ğŸš¨ CRITICAL Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          æ™ºæ¸¸åŠ©æ‰‹v6.2å…³é”®å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}
          ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}å¤„ç†æ‰‹å†Œ: {{ .Annotations.runbook_url }}{{ end }}
          
          {{ end }}
          
          è¯·ç«‹å³å¤„ç†æ­¤å‘Šè­¦ã€‚

  # æ”¯ä»˜ç³»ç»Ÿå…³é”®å‘Šè­¦
  - name: 'payment-critical'
    slack_configs:
      - channel: '#payment-critical'
        title: 'ğŸ’³ CRITICAL: æ”¯ä»˜ç³»ç»Ÿå…³é”®å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **ğŸ’³ æ”¯ä»˜ç³»ç»Ÿå…³é”®å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          **å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}
          
          **æ³¨æ„**: è¿™å¯èƒ½å½±å“ç”¨æˆ·æ”¯ä»˜ï¼Œè¯·ç«‹å³å¤„ç†ï¼
          {{ end }}
        send_resolved: true
        color: 'danger'
    email_configs:
      - to: 'payment-team@smarttravel.com,cto@smarttravel.com'
        subject: 'ğŸ’³ CRITICAL: æ”¯ä»˜ç³»ç»Ÿå‘Šè­¦ - {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

  # åº”ç”¨æœåŠ¡å…³é”®å‘Šè­¦
  - name: 'app-critical'
    slack_configs:
      - channel: '#app-critical'
        title: 'ğŸ”¥ CRITICAL: åº”ç”¨æœåŠ¡å…³é”®å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **ğŸ”¥ åº”ç”¨æœåŠ¡å…³é”®å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          **å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
        color: 'danger'

  # æ”¯ä»˜å›¢é˜Ÿå‘Šè­¦
  - name: 'payment-team'
    slack_configs:
      - channel: '#payment-alerts'
        title: 'ğŸ’³ æ”¯ä»˜ç³»ç»Ÿå‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **ä¸¥é‡ç¨‹åº¦**: {{ .Labels.severity }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}**å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true

  # åç«¯å›¢é˜Ÿå‘Šè­¦
  - name: 'backend-team'
    slack_configs:
      - channel: '#backend-alerts'
        title: 'âš™ï¸ åç«¯æœåŠ¡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **ä¸¥é‡ç¨‹åº¦**: {{ .Labels.severity }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}**å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true

  # å¹³å°å›¢é˜Ÿå‘Šè­¦
  - name: 'platform-team'
    slack_configs:
      - channel: '#platform-alerts'
        title: 'ğŸ–¥ï¸ å¹³å°åŸºç¡€è®¾æ–½å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **ä¸¥é‡ç¨‹åº¦**: {{ .Labels.severity }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}**å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true

  # äº§å“å›¢é˜Ÿå‘Šè­¦
  - name: 'product-team'
    slack_configs:
      - channel: '#product-alerts'
        title: 'ğŸ“Š ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **ä¸¥é‡ç¨‹åº¦**: {{ .Labels.severity }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}**å¤„ç†æ‰‹å†Œ**: {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true
